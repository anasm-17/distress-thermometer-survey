<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Distress Thermometer Survey</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --accent:#0b74ff; --muted:#666;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif; background:var(--bg); margin:0; padding:16px; color:#111;}
  .container{max-width:900px; margin:0 auto;}
  .card{background:var(--card); padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(10,10,20,0.06); margin-bottom:12px;}
  h1{font-size:20px; margin:0 0 8px 0;}
  label{display:block; margin:8px 0 4px;}
  input[type="text"], input[type="number"], select, textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #e3e7ee; box-sizing:border-box;}
  .row{display:flex; gap:8px; flex-wrap:wrap;}
  .left{flex:1 1 240px;}
  .small{flex:0 0 120px;}
  button{background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:600;}
  .question{margin-bottom:14px;}
  .options{display:flex; flex-direction:column; gap:8px;}
  .opt{display:flex; align-items:center; gap:10px; padding:8px; border-radius:8px; border:1px solid #eee; background:#fbfdff;}
  .opt img{width:56px; height:56px; object-fit:cover; border-radius:6px;}
  .controls{display:flex; justify-content:space-between; gap:8px; margin-top:8px; flex-wrap:wrap;}
  .muted{color:var(--muted); font-size:13px;}
  .toolbar{display:flex; gap:8px; margin-bottom:8px; justify-content:flex-end;}
  .lang-toggle{padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff;}
  .mini-row{display:flex; gap:8px; align-items:center; margin-left:auto;}
  .radio-label{display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:6px;}
  .sub-option{display:flex; align-items:center; gap:10px; width:100%; flex-wrap:wrap;}
  .sub-option .label-text{flex:1 1 220px; font-weight:500;}
  .answer-pill{font-size:13px; color:var(--muted);}
  @media (max-width:520px){ .opt img{width:48px;height:48px;} .mini-row{gap:6px;} .sub-option .label-text{flex-basis:100%;} }
</style>
</head>
<body>
<div class="container" id="app">
  <div class="toolbar card">
    <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
      <select id="lang" class="lang-toggle" title="Language">
        <option value="en">English</option>
        <option value="ur">اردو (Urdu)</option>
      </select>
      <button id="exportCsv">Export CSV</button>
      <button id="clearData" style="background:#ddd;color:#222;">Clear Local Data</button>
    </div>
  </div>

  <div id="pagePatient" class="card">
    <h1 id="title">Patient Info</h1>
    <div class="muted" id="sub">Please enter full name and patient ID.</div>
    <label id="labelName">Full name</label>
    <input id="fullName" type="text" placeholder="John Doe" />
    <label id="labelPID">Patient ID</label>
    <input id="patientId" type="text" placeholder="12345" />
    <label id="labelAge">Age (optional)</label>
    <input id="age" type="number" min="0" />
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="startSurvey">Start Survey</button>
      <button id="loadLatest" style="background:#eee;color:#222;">Load last saved</button>
    </div>
  </div>

  <div id="pageSurvey" class="card" style="display:none;">
    <h1 id="surveyTitle">Distress Thermometer</h1>
    <div id="questionsContainer"></div>
    <div class="controls">
      <div class="muted" id="progress">Question 0 / 0</div>
      <div>
        <button id="saveDraft" style="background:#6c757d;">Save Draft</button>
        <button id="finish" >Finish & Save</button>
      </div>
    </div>
  </div>

  <div id="pageDone" class="card" style="display:none;">
    <h1 id="doneTitle">Thanks — Saved</h1>
    <div class="muted" id="doneNote">You can export all results as CSV from top bar.</div>
    <div style="margin-top:12px;">
      <button id="backToStart">Start new</button>
    </div>
  </div>
</div>

<script>
// === Survey questions with English, Urdu, and optional image placeholders ===
const questions = [
  {
    id: "distress_score",
    type: "scale",
    en: "Please circle the number (0–10) that best describes how much distress you have been experiencing in the past week, including today.",
    ur: "براہ کرم آپ کو آج سمیت پچھلے ہفتے میں کس قدر تناؤ کا سامنا ہوا ہے اس کی بہترین وضاحت کرنے والے عدد 0–10 پر دائرہ بنائیں۔",
    min: 0, max: 10
  },

  /* Practical Concerns */
    {
      id: "practical_concerns",
      type: "checkbox",
      en: "Practical Concerns — Mark all that apply",
      ur: "عملی تشویشات — جو لاگو ہوں نشان زد کریں",
      options: [
        {value:"taking_care_of_myself", en:"My own well-being/self-care", ur:"اپنا خیال رکھنا/ذاتی دیکھ بھال", img:"images/Practical Concern/Taking care of myself.JPG"},
        {value:"taking_care_of_others", en:"Caring for others/Dependents", ur:"دوسروں کا خیال رکھنا/زیر کفالت افراد", img:"images/Practical Concern/Taking care of others.JPG"},
        {value:"work", en:"Work or job issues", ur:"کام یا ملازمت کے مسائل", img:"images/Practical Concern/Work.JPG"},
        {value:"school", en:"School or educational issues", ur:"اسکول یا تعلیمی مسائل", img:"images/Practical Concern/School.JPG"},
        {value:"housing", en:"Housing or accommodation", ur:"رہائش یا ٹھکانے کے مسائل", img:"images/Practical Concern/Housing.JPG"},
        {value:"finances", en:"Financial concerns", ur:"مالیاتی تشویشات", img:"images/Practical Concern/Finances.JPG"},
        {value:"insurance", en:"Insurance (health or other)", ur:"انشورنس (صحت یا دیگر)", img:"images/Practical Concern/Insurance.JPG"},
        {value:"transportation", en:"Transportation (getting around)", ur:"نقل و حمل (آنا جانا)", img:"images/Practical Concern/Transport.JPG"},
        {value:"child_care", en:"Child care", ur:"بچوں کی دیکھ بھال", img:"images/Practical Concern/Child care.JPG"},
        {value:"food", en:"Having enough food/Nutrition", ur:"کافی خوراک / غذائیت", img:"images/Practical Concern/Having enough food.JPG"},
        {value:"medicines", en:"Access to medicine", ur:"ادویات تک رسائی", img:"images/Practical Concern/Access to medicine.JPG"},
        {value:"treatment_decisions", en:"Making treatment decisions", ur:"علاج کے فیصلے کرنا", img:"images/Practical Concern/Treatment decisions.JPG"}
      ]
    },

  /* Family Concerns */
    {
      id: "family_concerns",
      type: "checkbox",
      en: "Family & Social Concerns — Mark all that apply",
      ur: "خاندانی و سماجی تشویشات — جو لاگو ہوں نشان زد کریں",
      options: [
        {value:"relationship_with_spouse_or_partner", en:"Relationship with spouse/partner", ur:"شریک حیات یا ساتھی کے ساتھ تعلقات", img:"images/Social Concern/Relationship with spouse.JPG"},
        {value:"relationship_with_children", en:"Relationship with children", ur:"بچوں کے ساتھ تعلقات", img:"images/Social Concern/Relationship with children.jpeg"},
        {value:"relationship_with_family_members", en:"Relationship with family members", ur:"خاندان کے دیگر افراد کے ساتھ تعلقات", img:"images/Social Concern/Relationship with family members.JPG"},
        {value:"relationship_with_friends_or_coworkers", en:"Relationship with friends/coworkers", ur:"دوستوں یا ساتھی کارکنوں کے ساتھ تعلقات", img:"images/Social Concern/Relationship with friends or co workers.JPG"},
        {value:"communication_with_health_care_team", en:"Communication with the healthcare team", ur:"صحت کی دیکھ بھال کرنے والی ٹیم کے ساتھ رابطہ/مواصلت", img:"images/Social Concern/Communciation with health care team.JPG"},
        {value:"ability_to_have_children", en:"Ability to have children/Fertility", ur:"بچے پیدا کرنے کی اہلیت / زرخیزی", img:"images/Social Concern/Abilty to have children 1.JPG"},
        {value:"prejudice_or_discrimination", en:"Prejudice or discrimination", ur:"تعصب یا امتیازی سلوک", img:"prejudice.jpeg"}
      ]
    },

  /* Emotional Concerns */
    {
      id: "emotional_concerns",
      type: "checkbox",
      en: "Emotional Concerns — Mark all that apply",
      ur: "جذباتی تشویشات — جو لاگو ہوں نشان زد کریں",
      options: [
        {value:"worry", en:"Worry or Anxiety", ur:"پریشانی یا اضطراب", img:"images/Emotional Concern/Worry or anixety.JPG"},
        {value:"sadness", en:"Sadness or Depression", ur:"اداسی یا افسردگی", img:"images/Emotional Concern/Sadness or deperssion.JPG"},
        {value:"loss_of_interest", en:"Loss of interest/enjoyment", ur:"دلچسپی یا خوشی میں کمی", img:"images/Emotional Concern/Loss of enjoyment or interest.JPG"},
        {value:"grief_or_loss", en:"Grief, mourning, or loss", ur:"غم، سوگ یا نقصان", img:"images/Emotional Concern/Grief or loss.JPG"},
        {value:"fear", en:"Fear or panic", ur:"خوف یا گھبراہٹ", img:"images/Emotional Concern/Fear.JPG"},
        {value:"loneliness", en:"Loneliness or isolation", ur:"تنہائی یا اکیلا پن", img:"images/Emotional Concern/Loneliness.JPG"},
        {value:"anger", en:"Anger or irritability", ur:"غصہ یا چڑچڑاپن", img:"images/Emotional Concern/Anger.JPG"},
        {value:"changes_in_apperance", en:"Changes in appearance/Body image", ur:"ظاہری شکل میں تبدیلیاں/جسم کا تصور", img:"images/Emotional Concern/Change in physical apperance.jpeg"},
        {value:"loss_of_control", en:"Feeling of loss of control", ur:"کنٹرول کھو دینے کا احساس", img:"images/Emotional Concern/Loss of control.png"},
        {value:"worthlessness_or_burden", en:"Feelings of worthlessness or being a burden", ur:"بیکار ہونے یا بوجھ بننے کا احساس", img:"images/Emotional Concern/Feeling of burden or worthlessness.JPG"}
      ]
    },

  /* Spiritual/Religious Concerns */
    {
      id: "spiritual_concerns",
      type: "checkbox",
      en: "Spiritual/Religious Concerns — Mark all that apply",
      ur: "روحانی و مذہبی تشویشات — جو لاگو ہوں نشان زد کریں",
      options: [
        {value:"meaning_or_purpose", en:"Sense of meaning or purpose in life", ur:"زندگی میں معنی یا مقصد کا احساس", img:"images/Spiritual and Religious Concern/Sense of meaning or purpose.png"},
        {value:"conflict_with_beliefs", en:"Changes in faith or beliefs", ur:"عقیدہ یا عقائد میں تبدیلی", img:"images/Spiritual and Religious Concern/Changes in faith or beliefs.JPG"},
        {value:"death_dying_afterlife", en:"Concerns about death, dying, or the afterlife", ur:"موت، مرنے یا آخرت کے بارے میں تشویش", img:"images/Spiritual and Religious Concern/Death.JPG"},
        {value:"conflict_between_beliefs_and_treatment", en:"Conflict between beliefs and treatment", ur:"عقائد اور علاج کے درمیان تصادم", img:"images/Spiritual and Religious Concern/Conflict between beliefs and cancer treatments.JPG"},
        {value:"relationship_with_sacred", en:"Relationship with God/the sacred", ur:"خدا / مقدس ہستی کے ساتھ تعلق", img:"images/Spiritual and Religious Concern/Relationship with the sacred.JPG"},
        {value:"ritual_or_dietary_needs", en:"Ritual or dietary needs/restrictions", ur:"رسمی یا غذائی ضروریات / پابندیاں", img:"images/Spiritual and Religious Concern/Ritual or dietary needs.JPG"},
        ]
    },

  /* Physical Problems */
    {
      id: "physical_problems",
      type: "checkbox",
      en: "Physical Concerns — Mark all that apply",
      ur: "جسمانی تشویشات — جو لاگو ہوں نشان زد کریں",
      options: [
        {value:"pain", en:"Pain", ur:"درد", img:"images/Physical Concern/Pain.JPG"},
        {value:"sleep", en:"Sleep problems (insomnia, etc.)", ur:"نیند کے مسائل (جیسے بے خوابی)", img:"images/Physical Concern/Sleep.JPG"},
        {value:"fatigue", en:"Fatigue or lack of energy", ur:"تھکن یا توانائی کی کمی", img:"images/Physical Concern/Fatigue.jpg"},
        {value:"changes_in_eating", en:"Changes in appetite/eating", ur:"بھوک/کھانے کی عادات میں تبدیلیاں", img:"images/Physical Concern/Changes in eating.JPG"},
        {value:"tobacco_use", en:"Tobacco use", ur:"تمباکو کا استعمال", img:"images/Physical Concern/Tobacco use.jpg"},
        {value:"substance_use", en:"Alcohol or substance use", ur:"الکحل یا ممنوعات کا استعمال", img:"images/Physical Concern/Substance use.JPG"},
        {value:"memory_concentration", en:"Memory or concentration problems", ur:"یادداشت یا ارتکاز کے مسائل", img:"images/Physical Concern/Memory or concentration.JPG"},
        {value:"sexual", en:"Sexual health or intimacy", ur:"جنسی صحت یا مباشرت", img:"images/Physical Concern/Sexual Health.JPG"},
        {value:"loss_or_change_of_physical_abilities", en:"Loss or change of physical abilities", ur:"جسمانی صلاحیتوں میں کمی یا تبدیلی", img:"images/Physical Concern/Change in physical abilities.JPG"}
      ]
    },
  {
    id: "other_concerns",
    type: "text",
    en: "Other concerns (optional)",
    ur: "دیگر تشویشات (اختیاری)"
  }
];

// ===== App logic (rendering, language toggle, local storage, CSV export) =====

const LANG = { current: localStorage.getItem('lang') || 'en' };

function el(q, ctx=document){ return ctx.querySelector(q); }

const langEl = el('#lang');
langEl.value = LANG.current;
langEl.addEventListener('change', e=>{
  LANG.current = e.target.value;
  localStorage.setItem('lang', LANG.current);
  applyLanguage();
});

function applyLanguage(){
  const ur = (LANG.current === 'ur');
  document.documentElement.lang = LANG.current === 'ur' ? 'ur' : 'en';
  document.documentElement.dir = ur ? 'rtl' : 'ltr';

  el('#title').textContent = ur ? 'مریض کی معلومات' : 'Patient Info';
  el('#sub').textContent = ur ? 'براہ کرم مکمل نام اور مریض آئی ڈی درج کریں۔' : 'Please enter full name and patient ID.';
  el('#labelName').textContent = ur ? 'پورا نام' : 'Full name';
  el('#labelPID').textContent = ur ? 'مریض آئی ڈی' : 'Patient ID';
  el('#labelAge').textContent = ur ? 'عمر (اختیاری)' : 'Age (optional)';
  el('#startSurvey').textContent = ur ? 'سروے شروع کریں' : 'Start Survey';
  el('#loadLatest').textContent = ur ? 'آخری محفوظ شدہ لوڈ کریں' : 'Load last saved';
  el('#surveyTitle').textContent = ur ? 'ڈسٹریس تھرما میٹر' : 'Distress Thermometer';
  el('#saveDraft').textContent = ur ? 'خاکہ محفوظ کریں' : 'Save Draft';
  el('#finish').textContent = ur ? 'ختم کریں اور محفوظ کریں' : 'Finish & Save';
  el('#doneTitle').textContent = ur ? 'شکریہ — محفوظ ہوگیا' : 'Thanks — Saved';
  el('#doneNote').textContent = ur ? 'آپ اوپر کے بٹن سے تمام نتائج CSV کے طور پر نکال سکتے ہیں۔' : 'You can export all results as CSV from top bar.';

  if(el('#pageSurvey').style.display !== 'none') renderQuestions();
}

function renderQuestions(){
  const container = el('#questionsContainer');
  container.innerHTML = '';
  questions.forEach((q, idx)=>{
    const qWrap = document.createElement('div');
    qWrap.className = 'question';
    const title = document.createElement('div');
    title.style.fontWeight='600';
    title.style.marginBottom='6px';
    title.textContent = (LANG.current==='ur' && q.ur) ? q.ur : q.en;
    qWrap.appendChild(title);

    const optionsWrap = document.createElement('div');
    optionsWrap.className = 'options';

    if(q.type === 'scale'){
      const row = document.createElement('div');
      row.style.display='flex'; row.style.gap='6px'; row.style.flexWrap='wrap';
      for(let i=q.min;i<=q.max;i++){
        const label = document.createElement('label');
        label.className = 'opt';
        label.style.padding='6px 8px';
        const r = document.createElement('input'); r.type='radio'; r.name=q.id; r.value=i;
        const span = document.createElement('span'); span.textContent = i;
        label.appendChild(r); label.appendChild(span);
        row.appendChild(label);
      }
      optionsWrap.appendChild(row);
    } else if(q.type === 'text'){
      const ta = document.createElement('textarea');
      ta.name = q.id; ta.rows=3; ta.style.width='100%';
      optionsWrap.appendChild(ta);
    } else if(q.options && q.options.length){
      // For each original "checkbox" option, render it as a sub-row with three radios: Yes / No / N/A
      q.options.forEach(opt=>{
        const optRow = document.createElement('div');
        optRow.className = 'opt';
        optRow.style.display = 'flex';
        optRow.style.alignItems = 'center';
        optRow.style.justifyContent = 'space-between';
        optRow.style.gap = '10px';
        // Left: image + label
        const left = document.createElement('div');
        left.className = 'sub-option';
        const textSpan = document.createElement('div');
        textSpan.className = 'label-text';
        textSpan.textContent = (LANG.current==='ur' && opt.ur) ? opt.ur : opt.en;
        left.appendChild(textSpan);
        if(opt.img){
          const img = document.createElement('img'); img.src = opt.img; img.alt = textSpan.textContent;
          left.insertBefore(img, textSpan);
        }
        optRow.appendChild(left);

        // Right: radio buttons (Yes / No / N/A)
        const mini = document.createElement('div');
        mini.className = 'mini-row';
        const choices = [
          {val:'Yes', en:'Yes', ur:'ہاں'},
          {val:'No', en:'No', ur:'نہیں'},
          {val:'N/A', en:'Not applicable', ur:'لاگو نہیں ہوتا'}
        ];
        choices.forEach(ch=>{
          const lbl = document.createElement('label');
          lbl.className = 'radio-label';
          const inp = document.createElement('input');
          inp.type = 'radio';
          // unique group per option so the three radios are mutually exclusive per option
          inp.name = `${q.id}__${opt.value}`;
          inp.value = ch.val;
          const span = document.createElement('span');
          span.textContent = (LANG.current==='ur' ? ch.ur : ch.en);
          lbl.appendChild(inp);
          lbl.appendChild(span);
          mini.appendChild(lbl);
        });
        optRow.appendChild(mini);
        optionsWrap.appendChild(optRow);
      });
    }

    qWrap.appendChild(optionsWrap);
    container.appendChild(qWrap);
  });

  el('#progress').textContent = `${questions.length} ${LANG.current==='ur' ? 'سوالات' : 'questions'}`;
}

// Collect responses
function collectResponse(){
  const patient = {
    fullName: el('#fullName').value.trim(),
    patientId: el('#patientId').value.trim(),
    age: el('#age').value ? Number(el('#age').value) : ''
  };
  const answers = {};
  questions.forEach(q=>{
    if(q.type === 'text'){
      const t = document.querySelector(`textarea[name="${q.id}"]`);
      answers[q.id] = t ? t.value.trim() : '';
    } else if(q.type === 'checkbox' && q.options && q.options.length){
      // Collect mini radio answers per option, stored as an object { optionValue: selection }
      const map = {};
      q.options.forEach(opt=>{
        const sel = document.querySelector(`input[name="${q.id}__${opt.value}"]:checked`);
        map[opt.value] = sel ? sel.value : ''; // '' if not answered
      });
      answers[q.id] = map;
    } else {
      const elSelected = document.querySelector(`input[name="${q.id}"]:checked`);
      answers[q.id] = elSelected ? elSelected.value : '';
    }
  });
  return {
    id: `resp_${Date.now()}`,
    ts: new Date().toISOString(),
    lang: LANG.current,
    patient,
    answers
  };
}

// Local storage helpers
function saveToLocal(response){
  const key = 'survey_responses';
  const existing = JSON.parse(localStorage.getItem(key) || '[]');
  existing.push(response);
  localStorage.setItem(key, JSON.stringify(existing));
  return existing.length;
}

function saveDraft(){
  const draftKey = 'survey_draft';
  const resp = collectResponse();
  localStorage.setItem(draftKey, JSON.stringify(resp));
  alert(LANG.current==='ur' ? 'خاکہ محفوظ ہوگیا' : 'Draft saved locally');
}

function loadDraft(){
  const d = localStorage.getItem('survey_draft');
  if(!d) { alert(LANG.current==='ur' ? 'کوئی ڈرافٹ نہیں' : 'No draft found'); return; }
  const resp = JSON.parse(d);
  el('#fullName').value = resp.patient.fullName || '';
  el('#patientId').value = resp.patient.patientId || '';
  el('#age').value = resp.patient.age || '';
  questions.forEach(q=>{
    if(q.type === 'text'){
      const ta = document.querySelector(`textarea[name="${q.id}"]`);
      if(ta) ta.value = resp.answers[q.id] || '';
    } else if(q.type === 'checkbox' && q.options && q.options.length){
      // resp.answers[q.id] should be an object mapping option->value
      const map = resp.answers[q.id] || {};
      q.options.forEach(opt=>{
        // uncheck all first
        document.querySelectorAll(`input[name="${q.id}__${opt.value}"]`).forEach(i=> i.checked = false);
        const val = map[opt.value];
        if(val){
          const node = document.querySelector(`input[name="${q.id}__${opt.value}"][value="${val}"]`);
          if(node) node.checked = true;
        }
      });
    } else {
      document.querySelectorAll(`input[name="${q.id}"]`).forEach(inp=>{
        inp.checked = (resp.answers[q.id] && inp.value==resp.answers[q.id]);
      });
    }
  });
  alert(LANG.current==='ur' ? 'ڈرافٹ لوڈ ہوگیا' : 'Draft loaded');
}

// CSV export
function exportCSV(){
  const key = 'survey_responses';
  const rows = JSON.parse(localStorage.getItem(key) || '[]');
  if(rows.length === 0) { alert(LANG.current==='ur' ? 'کوئی ڈیٹا موجود نہیں' : 'No data to export'); return; }

  const qids = questions.map(q=>q.id);
  const headers = ['id','ts','lang','fullName','patientId','age', ...qids];
  const csvRows = [headers.join(',')];

  rows.forEach(r=>{
    const vals = [
      csvEscape(r.id),
      csvEscape(r.ts),
      csvEscape(r.lang),
      csvEscape(r.patient.fullName || ''),
      csvEscape(r.patient.patientId || ''),
      csvEscape(r.patient.age || '')
    ];
    qids.forEach(qid=>{
      let v = r.answers[qid];
      if(Array.isArray(v)) {
        v = v.join('|');
      } else if (v && typeof v === 'object') {
        // convert map to compact string: key:Val|key2:Val2
        const pairs = Object.keys(v).map(k => `${k}:${v[k] || ''}`);
        v = pairs.join('|');
      }
      vals.push(csvEscape(v===undefined ? '' : String(v)));
    });
    csvRows.push(vals.join(','));
  });

  const blob = new Blob([csvRows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `survey_export_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function csvEscape(s){
  if (s === null || s === undefined) s = '';
  s = String(s); // ensure it's always a string
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return `"${s.replace(/"/g, '""')}"`;
  }
  return s;
}

// Event wiring
el('#startSurvey').addEventListener('click', ()=>{
  if(!el('#fullName').value.trim() || !el('#patientId').value.trim()){
    alert(LANG.current==='ur' ? 'براہ کرم نام اور مریض آئی ڈی درج کریں۔' : 'Please fill name and patient ID.');
    return;
  }
  el('#pagePatient').style.display = 'none';
  el('#pageSurvey').style.display = 'block';
  renderQuestions();
});

el('#loadLatest').addEventListener('click', ()=> loadDraft());
el('#saveDraft').addEventListener('click', ()=> saveDraft());

el('#finish').addEventListener('click', ()=>{
  const response = collectResponse();
  saveToLocal(response);
  el('#pageSurvey').style.display = 'none';
  el('#pageDone').style.display = 'block';
});

el('#backToStart').addEventListener('click', ()=>{
  el('#fullName').value = '';
  el('#patientId').value = '';
  el('#age').value = '';
  document.querySelectorAll('#questionsContainer input, #questionsContainer textarea').forEach(i=>{ if(i.type==='radio' || i.type==='checkbox') i.checked=false; else i.value=''; });
  el('#pageDone').style.display = 'none';
  el('#pagePatient').style.display = 'block';
});

el('#exportCsv').addEventListener('click', ()=> exportCSV());
el('#clearData').addEventListener('click', ()=>{
  if(confirm(LANG.current==='ur' ? 'کیا آپ واقعی مقامی ڈیٹا حذف کرنا چاہتے ہیں؟' : 'Really clear all local survey data?')){
    localStorage.removeItem('survey_responses');
    // optionally remove draft too
    localStorage.removeItem('survey_draft');
    alert(LANG.current==='ur' ? 'ڈیٹا حذف ہوگیا' : 'Data cleared');
  }
});

// Initialize
applyLanguage();
renderQuestions();

</script>
</body>
</html>
